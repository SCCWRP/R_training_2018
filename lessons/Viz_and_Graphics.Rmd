---
output:
  html_document:
    css: css/styles.css
---

```{r setup, echo=FALSE, warning=FALSE, purl=FALSE, message=FALSE}
options(repos = "http://cran.rstudio.com/")
pkgs <- c("dplyr", "knitr")
x<-lapply(pkgs, library, character.only = TRUE)
opts_chunk$set(tidy = FALSE, message = F, warning = F)
```

<script src="js/hideoutput.js"></script>

# Visualization and Graphics

## Lesson Outline

* [Base R graphics]
* [GGplot2]
* [Saving your plots]

## Lesson Exercises

* [Exercise 1]
* [Exercise 2]
* [Exercise 3]
* [Exercise 4]

# Today's goals

Our final workshop will introduce you to concepts of data visualization and graphics in R.  The entire workflow of data exploration is enhanced through looking at your data, whether you're creating publication-ready figures or you're exploring a dataset for the first time. Viewing your data provides insight into patterns that can help you explore different hypotheses.  No analysis is complete without a nice graphic.  

![](figure/data-science.png)

Graphics capabilities in R have improved tremendously in the last ten years. The de facto plotting library is `ggplot2` as part of the `tidyverse`, but there are many other packages available that enhance or build on existing functionality.  The base R installation comes with it's own set of plotting functions.  These are useful for quick and dirty exploration but you'll quickly find that these methods are tedious.  We'll start the lesson today with a cursory look at some of the base R plotting functions.  Most of what we'll discuss today will focus on ggplot2.

As before, we only have two hours to cover the basics of graphiing in R. It’s an unrealistic expectation that you will be a graphics ninja after this training. As such, the goals are to expose you to fundamentals and to develop an appreciation of what’s possible. I also want to provide resources that you can use for follow-up learning on your own.

Today you should be able to answer (or be able to find answers to) the following:

* What can I do with base R plots?
* What are the four requirements of every ggplot?
* What are geoms?
* What are facets?
* What are themes?
* How do I save a plot?

## Exercise 1

Once again, we're going to start the workshop by setting up a script in a new or existing RStudio project. We're going to work with the fully wrangled dataset we created at the end of the last training.  In the interest of time, you can download the formatted data [here](https://github.com/SCCWRP/R_training_2018/raw/master/lessons/data/formatted_data.xlsx).  This dataset is the joined sediment chemistry and station data for Bight08. We've already selected and renamed the columns we need from the chemistry data, filtered the data to get the parameters we want, and joined it with the station data to include latitude, longitude, and depth.  As a final step, we'll create a new categorical column for depth using the `cut` function.  

1. Create a new project in RStudio or use an existing project from last time. If creating a new project, name it "viz_workshop" or something similar.

1. Create a new "R Script" in the Source (scripting) Panel, save that file into your project and name it "graphics_and_viz.R".

1. Add in a comment line at the top stating the purpose. It should look something like: `# Graphics and vizualization in R`.  At the top of this script, add some code to load the `tidyverse` and `readxl` packages.

1. Make a folder in your project called `data` if don't have one already. If you haven't done so, download the formatted data from last time [here](https://github.com/SCCWRP/R_training_2018/raw/master/lessons/data/formatted_data.xlsx). Copy these files into the `data` folder in your project.

1. Add some lines to your script to import and store the formatted data in your Enviroment. Use the `read_excel` function to import `"data/formatted_data.csv"`. 

1. Use the `cut` function with `mutate` to create a new categorical column for depth. Name it `depth_cat` and cut it at 15 and 150 meters.  Remember that `cut` has two arguments for the `breaks` and `labels`.  The `breaks` argument will look like `breaks = c(-Inf, 15, 150, Inf)` and the `labels` argument will look like `labels= c('shallow', 'mid', 'deep')`.  

1. Check the data when you're done with `View` or `head`.  Also see how many values you have in each category in `depth_cat` (hint: `table(chemdat$depth_cat)`).

<div class="fold s o">
```{r results = 'hide'}
# Graphics and vizualization in R

# import libraries (use install.packages function if not found)
library(tidyverse)
library(readxl)

# import formatted data
# mutate depth to create a new categorical depth column
chemdat <- read_excel('data/formatted_data.xlsx') %>% 
  mutate(depth_cat = cut(depth, breaks = c(-Inf, 15, 150, Inf), labels = c('shallow', 'mid', 'deep')))

# check data
head(chemdat)
View(chemdat)
table(chemdat$depth_cat)
```
</div>

## Base R graphics

In theory, all of your plotting needs can be accomplished with functions in base R.  However, they are not easy to customize and are very tedious for creating publication-quality graphics.  For these reasons, base R graphics are rarely taught but I believe they still serve a purpose in the data exploration workflow. Base R graphics are extremely fast and simple to use for exploring data. I caution you in using these functions for anything beyond simple exploration.

My most frequent use for base R graphics inlude

* Simple scatterplots to see how two variables are related
* Histograms to explore the distribution of a variable

We'll explore some of these simple tools in base R with the `mpg` dataset. The workhorse plotting function is `plot`.  Let's make a simple plot of highway vs city mileage.
```{r}
plot(hwy ~ cty, data = mpg)
```

We created this plot using the `formula` notation.  We can also create the plot by calling the columns directly.
```{r}
plot(mpg$cty, mpg$hwy)
```

Confusing right? Let's have a look at the help file for `plot`.
```{r eval = F}
?plot
```
![](figure/plot_help.PNG)

This help file lays out some of the basics of plot formatting. We can change the type of plot `type` argument (here, we can only use points), give it a title with `main`, change labels on the x and y axes with `xlab` and `ylab`, and change the aspect ratio with `asp`. 
```{r}
plot(hwy ~ cty, data = mpg, main = 'Highway by city mileage', 
     xlab = 'city (mpg)', ylab = 'highway (mpg)')
```

The help file for the plot function also has this ambiguous `...` argument.  You'll see this argument for many functions in the help files.  This basically means that the function accepts arguments from other functions.  In this case, the plot function accepts arguments from the `par` function which is is used for setting graphical parameters in base R.  Let's look at the help file for `par`.

```{r eval = F}
?par
```
![](figure/par_help.png)
The most useful section in this help file is the description of the actual graphical parameters you can set. Some useful ones are the `cex` family of arguments for sizing, `col` family of arguments for color, the `pch` argument for point types, and the `family` argument for font.  All of these arguments can be passed directly to the `plot` function or as separately with the `par` function. The effect of these arguments on the plot is different depending on how they're used.
```{r}
plot(hwy ~ cty, data = mpg, main = 'Highway by city mileage', 
     xlab = 'city (mpg)', ylab = 'highway (mpg)', 
     col = 'blue', pch = 18, cex = 0.75, family = 'serif')
```

Or like this...
```{r}
par(col = 'blue', pch = 18, cex = 0.75, family = 'serif')
plot(hwy ~ cty, data = mpg, main = 'Highway by city mileage', 
     xlab = 'city (mpg)', ylab = 'highway (mpg)')
```

Notice how the plots are different depending on where the additional arguments are used. Confusing, right?  You'll waste a lot of time trying to tweak the base graphics.  

The `hist` (histogram) function is the only other plotting function from base R that is worth showing.  This gets you info on the basic distribution of a variable and is a graphical way of assessing the spread and central tendency (e.g., mean) of a variable.  
```{r}
hist(mpg$hwy)
```

The only useful argument in `hist` is `breaks` that controls the number of bins. 
```{r}
hist(mpg$hwy, breaks = 20)
```

## Exercise 2

Let's make some simple exploratory graphics of our chemistry dataset using base R.  We'll make a histogram of chlorophyll using the `hist` function, then make a scatterplot of chlorophyll versus total organic carbon using the `plot` function.  We'll also add some axis labels and titles to the plots to make it slightly more palatable.  

1. Make a histogram of `TotalCHL` using the `hist` function.  What's the approximate range of chlorophyll?  What's the most commonly observed value?  Try changing the `breaks` argument.  

1. Make a scatterplot of `TotalCHl` versus `TOC`with the `plot` function.  Try creating the plot using the `formula` notation (hint: `TotalCHL ~ TOC`).  Remember you have to use the `data` argument when you're using the formula. 

1. Give the plot an informative title using the `main`argument directly in the plot function, something like `main = "Chlorophyll vs TOC for Bight08"`.

1. Change the axis labels to include the units, something like `xlab = "Chl (ug/L)", ylab = "TOC (%)"`.

1. Use `par` before the `plot` function to change the font to `serif`, (hint: `par(family = "serif"))`).

<div class="fold s o">
```{r eval = F}
# histogram
hist(chemdat$Total_CHL)

# histogram, change breaks
hist(chemdat$Total_CHL, breaks = 20)

# scatterplot
plot(Total_CHL ~ TOC, data = chemdat)

# scatterplot with title
plot(Total_CHL ~ TOC, data = chemdat, main = 'Chlorophyll vs TOC for Bight08')

# scatterplot with title and better axis labels
plot(Total_CHL ~ TOC, data = chemdat, main = 'Chlorophyll vs TOC for Bight08',
     xlab = 'TOC (%)', ylab = 'Chl (ug/L)')

# change the font with par
par(family = 'serif')
plot(Total_CHL ~ TOC, data = chemdat, main = 'Chlorophyll vs TOC for Bight08',
     xlab = 'TOC (%)', ylab = 'Chl (ug/L)')
```
</div>

## GGplot2

## Exercise 3

## Exercise 4

## Saving your plots

## Next time 

Now you should be able to answer (or be able to find answers to) the following:

* What can I do with base R plots?
* What are the four requirements of every ggplot?
* What are geoms?
* What are facets?
* What are themes?
* How do I save a plot? 

## Attribution

Content in this lesson was pillaged extensively from the USGS-R training curriculum [here](https://github.com/USGS-R/training-curriculum) and [R for data Science](https://github.com/hadley/r4ds).