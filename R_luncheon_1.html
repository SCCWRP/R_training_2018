<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />




<title></title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-1.1/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-1.1/highlight.js"></script>
<script src="js/google-analytics.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs && document.readyState && document.readyState === "complete") {
   window.setTimeout(function() {
      hljs.initHighlighting();
   }, 0);
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>


</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}

.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>


<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->




<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}


.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
  padding-left: 25px;
  text-indent: 0;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>

<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-inverse  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">SCCWRP R training</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="Intro_to_R.html">Introduction to R</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Data wrangling
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="Data_Wrangling_1.html">Part 1</a>
    </li>
    <li>
      <a href="Data_Wrangling_2.html">Part 2</a>
    </li>
  </ul>
</li>
<li>
  <a href="Viz_and_Graphics.html">Viz and graphics</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    R luncheons
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="R_luncheon_1.html">R luncheon 1</a>
    </li>
    <li>
      <a href="R_luncheon_2.html">R luncheon 2</a>
    </li>
    <li>
      <a href="R_luncheon_3.html">R luncheon 3</a>
    </li>
    <li>
      <a href="R_luncheon_4.html">R luncheon 4</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">




</div>


<div id="r-luncheon-1" class="section level1">
<h1>R luncheon 1</h1>
<div id="lesson-outline" class="section level2">
<h2>Lesson Outline</h2>
<ul>
<li><a href="#problem-scope">Problem scope</a></li>
<li><a href="#housekeeping">Housekeeping</a></li>
<li><a href="#data-import">Data import</a></li>
<li><a href="#data-wrangle">Data wrangle</a></li>
<li><a href="#plot-the-data">Plot the data</a></li>
<li><a href="#summary">Summary</a></li>
</ul>
<p>Welcome to the first R luncheon! These short and informal sessions are designed for continued learning of R that builds off of our previous training sessions (access any of the earlier content from our <a href="index.html">home page</a>). Our goal is to understand how we use R to approach real-world examples in bite size chunks. Each session will focus on a selected problem that may be specific to a research area but contains analysis challenges that are shared no matter the context. The discussion will contain two parts:</p>
<ol style="list-style-type: decimal">
<li><p>Presentation of the problem: what we are starting with and where we want to go.</p></li>
<li><p>Steps to address the problem in general terms</p></li>
<li><p>Specific steps to address the problem using R</p></li>
<li><p>Execution of the workflow to achieve the final product.</p></li>
</ol>
<p>Please note that this is not an introduction to R. You are expected to have some background knowledge with the understanding that you may not be comfortable using R to complete all steps of an analysis. You should leave the session with a greater understanding of how R can help you develop an efficient and repeatable workflow for your own data challenges. I encourage lively discussion as we go through the workflow for each luncheon, so ask plenty of questions!</p>
</div>
</div>
<div id="problem-scope" class="section level1">
<h1>Problem scope</h1>
<p>Today’s session will use a compiled dataset that describes filtration of stormwater at different treatment locations in California. The dataset has measured influent and effluent concentrations of different water quality parameters that were measured during storm events. The general goal is to quantify filtration effectiveness by comparing influent/effluent concentrations with the storm events across several locations. This will provide a benchmark of how well stormwater treatment locations are filtering different water quality parameters during high flow events (i.e., storms).</p>
<div class="figure">
<img src="figure/rawdat.JPG" />

</div>
<p>We want to create a plot like this after getting the raw data in the correct format.</p>
<div class="figure">
<img src="figure/finalplo.JPG" />

</div>
<p>The data are messy. The spreadsheet includes measurements from different locations where record-keeping was not consistent. Each location may also include several filtration samples, with measurements for one or more storm events. There are several columns in the dataset, not all of which are relevant for our analysis. Here’s a screenshot:</p>
<div class="figure">
<img src="figure/lunchdatex.PNG" />

</div>
<p>We want to import the data, wrangle the information to a consistent format, and plot the data to help us assess how well the filtration systems are removing water quality constituents. Each of these steps can be performed in R.</p>
<ol style="list-style-type: decimal">
<li><p>Import the Excel spreadsheet</p></li>
<li><p>Wrangle the data to a consistent format. This will require removing extra columns we don’t need, filtering the observations (rows) for a water quality parameter we’re interested in, and develop a consistent convention that will allow to compare between stormwater treatment locations, filtration samples, and storm events.</p></li>
<li><p>Plot the data using a simple scatterplot of effluent concentration (y-axis) against influent concentration (x-axis). Our hope is that effluent concentrations will be lower than influent concentrations as a measure of how well the filtration systems are working.</p></li>
</ol>
</div>
<div id="housekeeping" class="section level1">
<h1>Housekeeping</h1>
<p>Let’s start by opening RStudio, creating a new project, and downloading the data to the project.</p>
<div id="open-rstudio" class="section level2">
<h2>Open RStudio</h2>
<p>Find the RStudio shortcut and fire it up. You should see something like this:</p>
<div class="figure">
<img src="figure/rstudio.png" />

</div>
</div>
<div id="create-a-new-project-in-rstudio" class="section level2">
<h2>Create a new project in RStudio</h2>
<p>To create a new project, click on the File menu at the top and select ‘New project…’</p>
<div class="figure">
<img src="figure/rstudio_proj.jpg" />

</div>
</div>
<div id="download-the-data-to-your-project" class="section level2">
<h2>Download the data to your project</h2>
<p>You can download the data from this <a href="https://sccwrp.github.io/SCCWRP_R_training/data/CA_DetentionBasin2.xlsx">link</a>. Once downloaded, you’ll have to copy and paste the Excel file to your project. Run <code>getwd()</code> in the R console if you’re not sure where this is.</p>
<p>You can also download the data file directly in R. This will download the data and save the file to your new RStudio project in a single step.</p>
<pre class="r"><code># download the data
download.file(
  url = &#39;https://sccwrp.github.io/SCCWRP_R_training/data/CA_DetentionBasin2.xlsx&#39;,
  destfile= &#39;CA_DetentionBasin2.xlsx&#39;
  )</code></pre>
</div>
</div>
<div id="data-import" class="section level1">
<h1>Data import</h1>
<p>Now that we’ve got our project setup with the data, let’s open a new script and load some R packages that we’ll be using.</p>
<p>Open a new script from the File menu…</p>
<div class="figure">
<img src="figure/rstudio_script.jpg" />

</div>
<p>Once the script is open, save it using the drop down file menu on the top left. Give it an informative name (e.g.,<code>Rluncheon1.R</code>) and save it in your project’s home directory. This should be the default location selected by RStudio when you save the file.</p>
<p>We’ll be using functions from the <a href="https://www.tidyverse.org/">tidyverse</a> collection of packages to import, wrangle, and plot the data. Checkout our training material <a href="https://sccwrp.github.io/SCCWRP_R_training/Data_Wrangling_1.html#the-tidyverse">here</a> if you need a brush up. Run this line in the R console if you don’t have the tidyverse installed.</p>
<pre class="r"><code>install.packages(&#39;tidyverse&#39;)</code></pre>
<p>In the script you just opened, add the following lines to load the tidyverse package and the readxl package (for data import).</p>
<pre class="r"><code>library(tidyverse)
library(readxl)</code></pre>
<p>Then add this line to import the dataset using the <code>read_excel()</code> function. The imported dataset will be assigned to the <code>dat</code> variable in the workspace for your current R session.</p>
<pre class="r"><code>dat &lt;- read_excel(&#39;CA_DetentionBasin2.xlsx&#39;)</code></pre>
<p>Let’s get a feeling for the dataset before we proceed.</p>
<pre class="r"><code>head(dat)</code></pre>
<pre><code>## # A tibble: 6 x 23
##    SITEID SITENAME    MSID MSNAME `Storm #` SAMPLEDATE          SAMPLETIME
##     &lt;dbl&gt; &lt;chr&gt;      &lt;dbl&gt; &lt;chr&gt;      &lt;dbl&gt; &lt;dttm&gt;              &lt;lgl&gt;     
## 1 -1.78e9 I-5 / S~ -1.02e9 27E           16 2001-03-06 00:00:00 NA        
## 2 -1.78e9 I-5 / S~  1.08e9 27I           18 2001-04-20 00:00:00 NA        
## 3 -1.78e9 I-5 / S~  1.08e9 27I           18 2001-04-21 00:00:00 NA        
## 4 -1.78e9 I-5 / S~  1.08e9 27I           15 2001-02-23 00:00:00 NA        
## 5 -1.78e9 I-5 / S~  1.08e9 27I            3 1999-03-26 00:00:00 NA        
## 6 -1.78e9 I-5 / S~  1.08e9 27I            9 2000-03-04 00:00:00 NA        
## # ... with 16 more variables: `WQX Parameter` &lt;chr&gt;, `Sample
## #   Fraction` &lt;chr&gt;, `WQ Analysis Value` &lt;dbl&gt;, `WQ Units` &lt;chr&gt;,
## #   MEDIA &lt;chr&gt;, QUAL &lt;chr&gt;, METHOD &lt;lgl&gt;, DLUnits &lt;chr&gt;, SGTCODE &lt;dbl&gt;,
## #   SGTCodeDescp &lt;chr&gt;, STCODE &lt;dbl&gt;, STCODEDescp &lt;chr&gt;, COMPOSITNU &lt;lgl&gt;,
## #   QAQC &lt;chr&gt;, Cat_AnalysisFlag &lt;chr&gt;, COMMENT &lt;chr&gt;</code></pre>
<pre class="r"><code>str(dat)</code></pre>
<pre><code>## Classes &#39;tbl_df&#39;, &#39;tbl&#39; and &#39;data.frame&#39;:    2875 obs. of  23 variables:
##  $ SITEID           : num  -1.78e+09 -1.78e+09 -1.78e+09 -1.78e+09 -1.78e+09 ...
##  $ SITENAME         : chr  &quot;I-5 / SR-56&quot; &quot;I-5 / SR-56&quot; &quot;I-5 / SR-56&quot; &quot;I-5 / SR-56&quot; ...
##  $ MSID             : num  -1.02e+09 1.08e+09 1.08e+09 1.08e+09 1.08e+09 ...
##  $ MSNAME           : chr  &quot;27E&quot; &quot;27I&quot; &quot;27I&quot; &quot;27I&quot; ...
##  $ Storm #          : num  16 18 18 15 3 9 18 11 14 16 ...
##  $ SAMPLEDATE       : POSIXct, format: &quot;2001-03-06&quot; &quot;2001-04-20&quot; ...
##  $ SAMPLETIME       : logi  NA NA NA NA NA NA ...
##  $ WQX Parameter    : chr  &quot;Kjeldahl nitrogen&quot; &quot;Arsenic&quot; &quot;Nickel&quot; &quot;Organic Carbon&quot; ...
##  $ Sample Fraction  : chr  &quot;Total&quot; &quot;Dissolved&quot; &quot;Total&quot; &quot;Total&quot; ...
##  $ WQ Analysis Value: num  5.7e-01 1.2 4.7 1.0e+01 7.6e+01 5.2e+01 2.3 1.1e+04 1.9e+02 2.0e-01 ...
##  $ WQ Units         : chr  &quot;mg/L&quot; &quot;µg/L&quot; &quot;µg/L&quot; &quot;mg/L&quot; ...
##  $ MEDIA            : chr  &quot;Water&quot; &quot;Water&quot; &quot;Water&quot; &quot;Water&quot; ...
##  $ QUAL             : chr  NA NA NA NA ...
##  $ METHOD           : logi  NA NA NA NA NA NA ...
##  $ DLUnits          : chr  &quot;mg/L&quot; &quot;µg/L&quot; &quot;µg/L&quot; &quot;mg/L&quot; ...
##  $ SGTCODE          : num  1 1 1 1 1 1 1 1 1 1 ...
##  $ SGTCodeDescp     : chr  &quot;Surface Runoff/Flow&quot; &quot;Surface Runoff/Flow&quot; &quot;Surface Runoff/Flow&quot; &quot;Surface Runoff/Flow&quot; ...
##  $ STCODE           : num  1 1 1 1 1 1 1 1 1 1 ...
##  $ STCODEDescp      : chr  &quot;Flow Weighted Composite EMCs&quot; &quot;Flow Weighted Composite EMCs&quot; &quot;Flow Weighted Composite EMCs&quot; &quot;Flow Weighted Composite EMCs&quot; ...
##  $ COMPOSITNU       : logi  NA NA NA NA NA NA ...
##  $ QAQC             : chr  NA NA NA NA ...
##  $ Cat_AnalysisFlag : chr  &quot;=&quot; &quot;=&quot; &quot;=&quot; &quot;n&quot; ...
##  $ COMMENT          : chr  NA &quot;10 30 09 Corrected MS ID to relate 27I to inflow instead of outflow.&quot; &quot;10 30 09 Corrected MS ID to relate 27I to inflow instead of outflow.&quot; &quot;10 30 09 Corrected MS ID to relate 27I to inflow instead of outflow.  Exc from analysis--appears to be duplicat&quot;| __truncated__ ...</code></pre>
</div>
<div id="data-wrangle" class="section level1">
<h1>Data wrangle</h1>
<p>There’s plenty of information in this dataset that we don’t need. Let’s pare it down so it’s more manageable for our question. Before we do that, we need to decide which columns are important and which water quality parameter we care about.</p>
<p>As mentioned before, we want to compare influent and effluent concentrations measured for one or more samples, for one or more storms, at different stormwater treatment locations. The columns we care about are:</p>
<ul>
<li><code>SITENAME</code>: unique identifier for the stormwater treatment location</li>
<li><code>MSNAME</code>: identifier for different samples from a stormwater treatment location, this is where the influent and effluent measurements are identified</li>
<li><code>Storm #</code>: identifier for storm events that occurred at a stormwater treatment location</li>
<li><code>WQX Parameter</code>: name of measured water quality values</li>
<li><code>WQ Analysis Value</code>: concentration of the measured water quality values, as influent or effluent</li>
</ul>
<p>We can use the <code>select()</code> function to pull the columns we want. Here we are using pipes to make the syntax a little more clear. Checkout the content <a href="https://sccwrp.github.io/SCCWRP_R_training/Data_Wrangling_1.html#selecting">here</a> for background on the <code>select()</code> function and <a href="https://sccwrp.github.io/SCCWRP_R_training/Data_Wrangling_1.html#piping">here</a> for a refresher on pipes.</p>
<pre class="r"><code>dat &lt;- dat %&gt;%
  select(SITENAME, MSNAME, `Storm #`,`WQX Parameter`, `WQ Analysis Value`)</code></pre>
<p>We just created a new <code>dat</code> object by overwriting the previous one we made when we imported the raw data. The new object contains only the columns we care about. Also note that some column names had to be surrounded by backticks (``). R doesnt’ like it when names have “special characters”, such as spaces, so sometimes we need to use the backticks when calling the name.</p>
<p>Now that we have the columns we want, we still need to get the observations for the water quality parameter we want to analyze. Let’s see what’s available:</p>
<pre class="r"><code>unique(dat$`WQX Parameter`)</code></pre>
<pre><code>##  [1] &quot;Kjeldahl nitrogen&quot;                
##  [2] &quot;Arsenic&quot;                          
##  [3] &quot;Nickel&quot;                           
##  [4] &quot;Organic Carbon&quot;                   
##  [5] &quot;Hardness, carbonate&quot;              
##  [6] &quot;Fecal Coliform&quot;                   
##  [7] &quot;Zinc&quot;                             
##  [8] &quot;Cadmium&quot;                          
##  [9] &quot;Chromium&quot;                         
## [10] &quot;pH&quot;                               
## [11] &quot;Total suspended solids&quot;           
## [12] &quot;Phosphorus as P&quot;                  
## [13] &quot;Copper&quot;                           
## [14] &quot;Lead&quot;                             
## [15] &quot;Nitrogen, Nitrate (NO3) as N&quot;     
## [16] &quot;Total dissolved solids&quot;           
## [17] &quot;Specific conductance&quot;             
## [18] &quot;Phosphorus, orthophosphate as PO4&quot;</code></pre>
<p>Let’s pull out the rows for lead. We can use the <code>filter()</code> function to get these rows by “filtering” the observations where <code>WQX Parameter</code> is equal to <code>Lead</code>. See <a href="https://sccwrp.github.io/SCCWRP_R_training/Data_Wrangling_1.html#filtering">here</a> for a refresher of filter.</p>
<pre class="r"><code>dat &lt;- dat %&gt;% 
  filter(`WQX Parameter` == &#39;Lead&#39;)</code></pre>
<p>Let’s examine our handywork:</p>
<pre class="r"><code>str(dat)</code></pre>
<pre><code>## Classes &#39;tbl_df&#39;, &#39;tbl&#39; and &#39;data.frame&#39;:    296 obs. of  5 variables:
##  $ SITENAME         : chr  &quot;I-5 / SR-56&quot; &quot;I-5 / SR-56&quot; &quot;I-5 / SR-56&quot; &quot;I-5 / SR-56&quot; ...
##  $ MSNAME           : chr  &quot;27E&quot; &quot;27I&quot; &quot;27E&quot; &quot;27E&quot; ...
##  $ Storm #          : num  15 2 17 6 15 9 2 18 13 8 ...
##  $ WQX Parameter    : chr  &quot;Lead&quot; &quot;Lead&quot; &quot;Lead&quot; &quot;Lead&quot; ...
##  $ WQ Analysis Value: num  1 29 8.1 1.5 57 10 1 1 1.3 7 ...</code></pre>
<pre class="r"><code>head(dat)</code></pre>
<pre><code>## # A tibble: 6 x 5
##   SITENAME    MSNAME `Storm #` `WQX Parameter` `WQ Analysis Value`
##   &lt;chr&gt;       &lt;chr&gt;      &lt;dbl&gt; &lt;chr&gt;                         &lt;dbl&gt;
## 1 I-5 / SR-56 27E           15 Lead                            1  
## 2 I-5 / SR-56 27I            2 Lead                           29  
## 3 I-5 / SR-56 27E           17 Lead                            8.1
## 4 I-5 / SR-56 27E            6 Lead                            1.5
## 5 I-5 / SR-56 27I           15 Lead                           57  
## 6 I-5 / SR-56 27E            9 Lead                           10</code></pre>
<p>Much more manageable! Now comes the hard part… we need to get the data in a format where we can easily compare the influent and effluent concentrations, while keeping the data structured in a way so that samples for each storm event and each treatment location are consistently referenced in the rows. This is information in the dataset that needs to be retained to meaningfully evaluate filtration effectiveness. We can’t easily compare the influent/effluent concentrations in the current data because they are in the same column!</p>
<p>Here’s an example of what the data should look like for us to plot effluent against influent:</p>
<pre><code>## # A tibble: 6 x 5
##   SITENAME MSNAME  `Storm #` influent effluent
##   &lt;chr&gt;    &lt;chr&gt;       &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
## 1 site1    sample1         1     9.71     3.56
## 2 site1    sample2         1     6.26     5.13
## 3 site1    sample3         1     9.94     4.42
## 4 site2    sample1         1     8.78     5.42
## 5 site2    sample2         2     6.96     6.31
## 6 site2    sample3         1     9.04     5.66</code></pre>
<p>There are three things about this dataset that differ from our actual data:</p>
<ol style="list-style-type: decimal">
<li><p>Consistent naming convention between sites and samples</p></li>
<li><p>Separate columns for influent and effluent</p></li>
<li><p>Each row references the site name, sample name, and storm number correctly for the influent and effluent observations</p></li>
</ol>
<p>Before we proceed, we’ll make life a little easier by taking care of the storms column. Nabiul assures me that we can average the concentrations for multiple storm events for each site and sample combination and still meaningfully evaluate filtration efficiency. This will also get us to lunch quicker… so, we can use some tools from the dplyr package (as part of the tidyverse) to make our lives easier. We will use <code>group_by()</code> and <code>summarise()</code> to average the water quality concentrations across storms for the unique site/sample combinations (see <a href="https://sccwrp.github.io/SCCWRP_R_training/Data_Wrangling_2.html#group_by_and_summarize">here</a> for more info).</p>
<pre class="r"><code>dat &lt;- dat %&gt;% 
  group_by(SITENAME, MSNAME) %&gt;% 
  summarise(avewq = mean(`WQ Analysis Value`))
str(dat)</code></pre>
<pre><code>## Classes &#39;grouped_df&#39;, &#39;tbl_df&#39;, &#39;tbl&#39; and &#39;data.frame&#39;:  10 obs. of  3 variables:
##  $ SITENAME: chr  &quot;I-15/SR-78 EDB&quot; &quot;I-15/SR-78 EDB&quot; &quot;I-5 / I-605 EDB&quot; &quot;I-5 / I-605 EDB&quot; ...
##  $ MSNAME  : chr  &quot;37E&quot; &quot;37I&quot; &quot;4E&quot; &quot;4I&quot; ...
##  $ avewq   : num  8.44 38.25 19.35 34.65 8 ...
##  - attr(*, &quot;vars&quot;)= chr &quot;SITENAME&quot;
##  - attr(*, &quot;drop&quot;)= logi TRUE</code></pre>
<pre class="r"><code>head(dat)</code></pre>
<pre><code>## # A tibble: 6 x 3
## # Groups:   SITENAME [3]
##   SITENAME        MSNAME avewq
##   &lt;chr&gt;           &lt;chr&gt;  &lt;dbl&gt;
## 1 I-15/SR-78 EDB  37E     8.44
## 2 I-15/SR-78 EDB  37I    38.2 
## 3 I-5 / I-605 EDB 4E     19.4 
## 4 I-5 / I-605 EDB 4I     34.6 
## 5 I-5 / SR-56     27E     8   
## 6 I-5 / SR-56     27I    20.1</code></pre>
<p>We are almost there. Now we just need to get the influent and effluent values in different columns. If you recall our earlier training sessions <a href="https://sccwrp.github.io/SCCWRP_R_training/Data_Wrangling_2.html#spreading">here</a>, we can use the <code>spread()</code> function from the tidyr package (again, included in the tidyverse). This function lets us “spread” values in one column to multiple columns using “key” values in a second column. The key values are used as the column names for the values that are spread from one to many columns.</p>
<p>Here’s an example of spreading with a different dataset:</p>
<div class="figure">
<img src="figure/tidy-8.png" />

</div>
<p>Let’s try this on our dataset, where the key column is <code>MSNAME</code> and the value column is <code>avewq</code> from our summarised data.</p>
<pre class="r"><code>dat %&gt;%
  spread(MSNAME, avewq)</code></pre>
<pre><code>## # A tibble: 5 x 11
## # Groups:   SITENAME [5]
##   SITENAME     `27E` `27I` `31E` `31I` `37E` `37I`  `4E`  `4I`  `5E`  `5I`
## * &lt;chr&gt;        &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1 I-15/SR-78 ~    NA  NA    NA    NA    8.44  38.2  NA    NA    NA    NA  
## 2 I-5 / I-605~    NA  NA    NA    NA   NA     NA    19.4  34.6  NA    NA  
## 3 I-5 / SR-56      8  20.1  NA    NA   NA     NA    NA    NA    NA    NA  
## 4 I-5/Manches~    NA  NA    18.3  67.9 NA     NA    NA    NA    NA    NA  
## 5 I-605 / SR-~    NA  NA    NA    NA   NA     NA    NA    NA    33.0  65.4</code></pre>
<p>So this isn’t exactly right. The data are definitely spread but we have unique columns for every influent/effluent sample in our dataset. We’ll need to separate the sample names and the influent/effluent designations in the <code>MSNAME</code> column before we can proceed. If you recall from our past training, these data are not <a href="https://sccwrp.github.io/SCCWRP_R_training/Data_Wrangling_2.html#tidy_data">“tidy”</a>, meaning, among other things, that the <code>MSNAME</code> column contains two pieces of information in one cell. The column includes information on both the sample name and the influent/effluent designation.</p>
<p>There’s a handy function from base R called <code>gsub()</code> that lets you find patterns in a character string and replace them with values of your choosing. Here, we want to create two new columns from <code>MSNAME</code>, one with only the sample name (numbers) and another with only the influent/effluent designations (letters). This will allow the <code>spread()</code> function to create a single column for influent and a single column for effluent, while retaining the correct sample and site names in the rows. This can be done as follows:</p>
<pre class="r"><code>dat &lt;- dat %&gt;% 
  mutate(
    samplename = gsub(&#39;[aA-zZ]+&#39;, &#39;&#39;, MSNAME),
    infeff = gsub(&#39;[0-9]+&#39;, &#39;&#39;, MSNAME)
  )
dat</code></pre>
<pre><code>## # A tibble: 10 x 5
## # Groups:   SITENAME [5]
##    SITENAME              MSNAME avewq samplename infeff
##    &lt;chr&gt;                 &lt;chr&gt;  &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt; 
##  1 I-15/SR-78 EDB        37E     8.44 37         E     
##  2 I-15/SR-78 EDB        37I    38.2  37         I     
##  3 I-5 / I-605 EDB       4E     19.4  4          E     
##  4 I-5 / I-605 EDB       4I     34.6  4          I     
##  5 I-5 / SR-56           27E     8    27         E     
##  6 I-5 / SR-56           27I    20.1  27         I     
##  7 I-5/Manchester (east) 31E    18.3  31         E     
##  8 I-5/Manchester (east) 31I    67.9  31         I     
##  9 I-605 / SR-91 EDB     5E     33.0  5          E     
## 10 I-605 / SR-91 EDB     5I     65.4  5          I</code></pre>
<p>We just used the <code>mutate()</code> function to create two new columns, where <code>samplename</code> was created by finding all letters in <code>MSNAME</code> and removing them and <code>infeff</code> was created by finding all digits in <code>MSNAME</code> and removing them. The <code>gsub()</code> function is very powerful and uses “regular expression matching” to search for patterns in the character strings that can be replaced (in this case, with nothing <code>''</code>). This could easily cover a few hours of instruction, but here’s a <a href="https://www.rstudio.com/wp-content/uploads/2016/09/RegExCheatsheet.pdf">cheatsheet</a> on regular expressions if you want to learn on your own.</p>
<p>Now all we have to do is remove the old <code>MSNAME</code> column and spread as before.</p>
<pre class="r"><code>dat &lt;- dat %&gt;% 
  select(-MSNAME) %&gt;% 
  spread(infeff, avewq)
dat</code></pre>
<pre><code>## # A tibble: 5 x 4
## # Groups:   SITENAME [5]
##   SITENAME              samplename     E     I
## * &lt;chr&gt;                 &lt;chr&gt;      &lt;dbl&gt; &lt;dbl&gt;
## 1 I-15/SR-78 EDB        37          8.44  38.2
## 2 I-5 / I-605 EDB       4          19.4   34.6
## 3 I-5 / SR-56           27          8     20.1
## 4 I-5/Manchester (east) 31         18.3   67.9
## 5 I-605 / SR-91 EDB     5          33.0   65.4</code></pre>
</div>
<div id="plot-the-data" class="section level1">
<h1>Plot the data</h1>
<p>Now we’re ready to plot! Let’s use ggplot (refresher <a href="https://sccwrp.github.io/SCCWRP_R_training/Viz_and_Graphics.html#ggplot2">here</a> to make a simple scatterplot with a trend line.</p>
<pre class="r"><code>ggplot(dat, aes(x = I, y = E)) +
  geom_point() + 
  stat_smooth(method = &#39;lm&#39;, se = F)</code></pre>
<p><img src="R_luncheon_1_files/figure-html/unnamed-chunk-16-1.png" width="672" /></p>
<p>Let’s make the comparisons a little easier to see. We’ll add a line through the origin and use the same scale for both axes.</p>
<pre class="r"><code>ggplot(dat, aes(x = I, y = E)) +
  geom_point() + 
  stat_smooth(method = &#39;lm&#39;, se = F) + 
  geom_abline(intercept = 0, slope = 1, linetype = &#39;dashed&#39;) + 
  scale_y_continuous(limits = c(0, 70)) +
  scale_x_continuous(limits = c(0, 70)) + 
  coord_equal()</code></pre>
<p><img src="R_luncheon_1_files/figure-html/unnamed-chunk-17-1.png" width="672" /></p>
</div>
<div id="summary" class="section level1">
<h1>Summary</h1>
<p>Let’s recap the steps:</p>
<ol style="list-style-type: decimal">
<li><p>Imported the Excel spreadsheet using the <code>read_excel()</code> function from the readxl package (in tidyverse)</p></li>
<li>Wrangled the data to a consistent format.
<ol style="list-style-type: decimal">
<li>Selected the columns we wanted using <code>select()</code></li>
<li>Filtered the rows for lead using <code>filter()</code></li>
<li>Averaged concenctrations across storm events using <code>group_by()</code> and <code>summarise()</code></li>
<li>Created unique columns for sample name and influent/effluent categories using <code>mutate()</code> and <code>gsub()</code></li>
<li>Spread the data using <code>spread()</code> to get the influent/effluent concentrations in differnt columns</li>
</ol></li>
<li><p>Compared the effluent and influent concentrations using ggplot</p></li>
</ol>
<p>Our conclusion? Looks like the filters are doing a good job removing lead from the stormwater.</p>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
